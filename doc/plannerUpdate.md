Отлично, задача понятна: в **PLANNER/Goals** нужно спроектировать универсальную систему прогресса, которая работает для разных типов целей (покупка автомобиля, изучение языка, чтение книг и т. д.) и синхронно интегрируется с **Tasks**, **Habits**, **Finance**, **Insights** и **Home**. Ниже — сжатая выжимка лучших практик из рынка + детальная спецификация «как сделать у вас».

---

## 1) Что делают лучшие продукты (и что нам взять)

* **Apple Fitness (кольца Move/Exercise/Stand)** — каждый день есть простой, замкнутый цикл «закрыть кольца», мощная визуализация + ежемесячные челленджи. Фишка — ежедневная, быстрая обратная связь и «кольца прогресса», которые видно везде. ([Apple][1])
* **Duolingo (ежедневная цель по XP, streak)** — минимальная дневная планка (10–50 XP), streak как «якорь» привычки, мягкая система энергии (в 2025 переход с «сердец» на «энергию») — фокус на позитивном подкреплении. ([Duolingo Blog][2])
* **Todoist Karma (поинты, уровни, streak)** — прогресс виден в графиках, есть дневные/недельные цели, уровни как «мета-цель». Хорошо масштабируется на любые задачи. ([Todoist][3])
* **Strava Goals (неделя/месяц/год + тип метрики)** — цели по дистанции/времени/кол-ву активностей/набору высоты с периодизацией; сильная «скорость/пейс» vs «требуемый темп». ([Strava Support][4])
* **YNAB Targets (финансовые «таргеты»: дата, сумма, ритм)** — задаешь «сколько к дате» или «ежемесячно», продукт ведет кумулятивно и подсказывает «догоняющие» суммы при отставании. ([support.ynab.com][5])

> **Важно:** streak‑механики классно удерживают, но при неправильной настройке могут перегибать («навязчивое» сохранение streak). Делаем «грейс-дни» и мягкие сценарии восстановления. ([The Guardian][6])

---

## 2) Универсальный механизм прогресса (UPE — Universal Progress Engine)

### 2.1. Таксономия целей (шаблоны)

1. **Накопление/покупка** (сумма к дате) — «Купить авто», «Отпуск».
2. **Снижение/погашение** (уменьшение остатка) — «Погасить долг/вес/процент жира».
3. **Кумулятивная количественная** (шт./км./часы до целевого числа) — «Прочитать 24 книги», «Пробежать 500 км».
4. **Норматив за период (rate)** — «Учить английский 300 мин/нед», «2 тренировки/нед».
5. **Качественная/скилловая** (вехи + XP‑система) — «Дойти до A2 в языке», «Сдать сертификацию».
6. **Чек‑лист/проект** (веса по вехам) — «Получить права: медкомиссия→экзамен→вождение».
7. **Составные** — комбинации из выше (напр., «Выучить язык»: минуты/нед + контрольные тесты + завершение курсов).

> В **PLANNER** уже заложены типы «Финансовая/Количественная/Качественная» и вехи (Milestones). Мы расширяем и формализуем расчёты. 

### 2.2. Единая модель данных Goal

```json
Goal {
  id, type, title, description, category, color,
  unit,            // "UZS", "км", "мин", "шт", "XP", "%"
  baseline,        // стартовое значение (напр. 0 UZS)
  target,          // целевое значение
  deadline,        // опционально
  cadence,         // none / weekly / monthly / yearly
  milestones: [{id, title, weight=1, target?, unit?}],
  sources: { tasks:bool, habits:bool, finance:bool, manual:bool, focus:bool },
  pacing: { method: "linear|adaptive", window_days: 30 },
  notifications: { ... },
  privacy: { ... }
}
```

### 2.3. События (ingestion) из модулей

* `task_completed(taskId, duration, energy, tags)` → прогресс количественных/чек‑лист целей. 
* `habit_marked(habitId, done)` → streak/доля выполнения для rate/привычек. 
* `focus_session(focusId, minutes)` → минуты в скилловые/учебные цели. 
* `finance_tx(accountId, amount, currency, type, tags)` → вклад/погашение для финансовых целей + авто‑конвертация по курсам. 
* `manual_update(value, note)` → ручной апдейт.
* Все события пишем в `ProgressEvent` журнал с тайм‑стемпом.

### 2.4. Расчётные снапшоты (каждый день/при событии)

`ProgressSnapshot { date, current_value, percent_complete, on_track_flag, eta_date, pace_required, pace_actual, confidence }`

* **ETA/Прогноз:** линейная регрессия по последним N периодам (по умолч. 30 дней) + «требуемый темп». Если `pace_actual <= 0` → статус *At Risk*.
* **On‑Track:** `pace_actual >= 0.9 * pace_required` (порог настраиваемый).
* **Confidence:** 1 − CoV (коэф. вариации) темпа за окна N.

> **INSIGHTS** подхватывает снапшоты в PDI/отчёты и строит прогнозные карточки («дойдёте к Марту 2025», «нужно +20% темпа»). 

---

## 3) Формулы прогресса по типам

### 3.1. Финансовая цель «Сумма к дате» (напр., купить авто)

* **Текущее**: `current = baseline + Σ(вклады, сконвертированные в базовую валюту)`
* **% прогресса**: `percent = clamp((current - baseline) / (target - baseline), 0..1)`
* **Требуемый темп**: `pace_required = (target - current) / months_remaining` (или недельный)
* **Факт темпа**: среднее `Σ(вклады)/кол-во периодов` за окно
* **On‑Track**/ETA как выше.
* **Интеграция с Finance**:

  * Авто‑линковать вклад к цели через тег/«копилку»; поддержать мультивалюту (курсы управляются в Finance UI). 
  * Виджет «Добавить вклад» прямо на карточке цели.
  * Бюджетная подсказка («заморозить N/мес»).
* **UI**: прогресс‑бар + «Осталось 900 000 UZS • Требуется 300k/мес • Прогноз: март 2025». (совпадает с паттернами карточки Goals) 
* **Почему так:** повторяет логику YNAB Targets с подсказками catch‑up при просадках. ([support.ynab.com][5])

### 3.2. Погашение долга

* **Текущее**: `current = baseline - выплаченный_принципал`
* **%**: `1 - остаток/target_principal`
* **План**: график амортизации (Avalanche/Snowball — можно дать выбор).
* **Интеграция**: использовать раздел «Долги» с платежами/напоминаниями; цель «0 по принципалу» к дате. 

### 3.3. Количественная кумулятивная (шт./км./часы)

* **Текущее**: сумма выполненного.
* **%**: `current/target`.
* **Периодизация**: опция «цель на год» + авто‑разбивка по неделям/месяцам (как у Strava). ([Strava Support][4])

### 3.4. Норматив за период (rate, например «минут/нед»)

* **Прогресс недели**: `minutes_this_week / weekly_target`.
* **Ожидание «к текущему моменту»**: `weekly_target * (elapsed_week_fraction)`.
* **Индикатор кольцом** по стилю Apple/Todoist («закрой норму дня/недели»). ([Apple Developer][7])

### 3.5. Скилл/качество (язык, сертификация): XP + вехи

* **XP‑слой** (быстрые, мелкие шаги): 1 XP за 5 мин фокуса/изучения + бонус за тест/уровень.
* **Milestones** (контрольные точки с весами): «A1 → A2», «500 слов», «завершить модуль».
* **%** = `w_sum(completed_milestones)/w_sum(all_milestones)` * 60%  + нормализованный вклад XP * 40%.
* **Streak‑механика**: «учись каждый день ≥ X мин» (гибкий порог) + **Grace‑дни** 1–2/мес + «мягкое восстановление» (не ломаем мотивацию). ([Duolingo Blog][2])
* **NB:** Duolingo в 2025 смягчает механику наказаний (энергия вместо «сердец») — берем подход «поощрение за серию уроков». ([The Verge][8])

### 3.6. Чек‑лист/проект (вехи с весами)

* Вес по умолчанию = 1, можно менять.
* **%** = `Σ weights_done / Σ weights_total`.
* Поддержать привязку задач (Tasks) к каждой вехе с авто‑закрытием при выполнении. 

---

## 4) UX‑паттерны (единый язык прогресса)

### 4.1. Карточка цели (Goals)

* **Крупный %**, **полоса** или **кольцо** (для дневных/недельных норм), **пейс‑чип** «На курсе / Отстаем», **ETA**.
* **Primary‑CTA** зависит от типа: «Добавить вклад», «Отметить учебу», «Добавить прогресс», «Завершить веху».
* Поля «Прогресс/Осталось/Темп/Прогноз» уже описаны в макете — сохраняем стилистику. 

### 4.2. Home → виджет «GOALS»

* Топ‑3 цели, мини‑индикаторы, быстрые действия. Соответствует текущему описанию Home. 

### 4.3. Insights

* Карточки «Прогресс целей», вклад в **PDI**, авто‑инсайты («Вы опережаете план на 12%», «До цели 19 дней темпа»), включение в отчеты/дайджесты. 

### 4.4. Finance

* Финцели → «копилки/таргеты» + встроенная конвертация/курсы + предупреждения при риске срыва. 

### 4.5. Gamification

* XP за шаги по целям, уровни/ачивки, «celebration» при вехах — все ложится на систему в MORE. 

---

## 5) Интеграция по модулям (синхронная работа)

| Действие                        | Источник | Как влияет на цель                                            |
| ------------------------------- | -------- | ------------------------------------------------------------- |
| Выполнена задача «Сдать A1»     | Tasks    | Закрывает веху → +прогресс цели «Английский A2»               |
| Пометили привычку «Учить англ.» | Habits   | +минуты недели, поддержка streak/кольца недели                |
| Фокус‑сессия 45 мин             | Focus    | +XP/время в учебную цель, апдейт «пейс недели»                |
| Добавили вклад 300 000 UZS      | Finance  | +к прогрессу «Купить авто», пересчет ETA/пейса, мультивалюта  |
| Отчет/инсайт сформирован        | Insights | Показывает тренды и прогнозы по целям (вклад в PDI)           |
| Ачивка/уровень                  | MORE     | Награды за ключевые вехи/серии («12 недель без пропусков»)    |
| Виджет «Goals»                  | Home     | Быстрые действия и обзор прогресса по топ‑целям               |

---

## 6) Конкретные шаблоны (готовые пресеты)

### 6.1. «Купить авто»

* **Тип**: Финансовая. **База**: 0 UZS. **Цель**: 5 000 000 UZS. **Дедлайн**: 31 марта 2025.
* **Прогресс**: вклад‑события из Finance (с конвертацией). **Пейс**: мес.
* **UI**: «4 100 000 / 5 000 000 UZS • Осталось 900 000 • Требуется 300k/мес • Прогноз: март 2025». 
* **Инсайты**: «При текущем темпе успеете» / «Нужно +20% вкладов» (как у YNAB catch‑up). ([support.ynab.com][5])

### 6.2. «Выучить английский до A2»

* **Тип**: Скилл (XP + вехи).
* **Вехи**: A1‑тест (0.2), 500 слов (0.2), 30 уроков (0.2), A2‑грамматика (0.2), Итоговый тест (0.2).
* **Норма**: 300 мин/нед (кольцо недели + streak).
* **XP**: 1 XP / 5 мин фокуса (помодоро/фокус‑режим).
* **Мягкий streak**: 2 grace‑дня/мес, опциональный «заморозить день». ([Duolingo Blog][2])
* **Инсайты**: пик продуктивности по времени (перенос на нужные слоты). 

### 6.3. «Прочитать 24 книги в год»

* **Тип**: Количественная. `target = 24`.
* **Опционально**: трекать страницы → равномерный вес по страницам.
* **Периодизация**: ежемесячно 2 книги; warning если отставание >1 книги.
* **Связка**: привычка «Чтение 20 мин/день», фокус‑сессии.

### 6.4. «Бег 500 км в 2025»

* **Тип**: Количественная кумулятивная.
* **Периодизация**: weekly/monthly цели как у Strava; кольцо недели. ([Strava Support][4])

---

## 7) Нотификации и мотивация (с этикой)

* **Ежедневные/недельные «кольца»**: закрыть норму дня/недели (от Apple Fitness). ([Apple][1])
* **Nudge‑пары**: «сейчас ваш пик энергии» (из Insights) + «начать фокус 25 мин». 
* **Streak‑защита**: grace‑дни, «восстановление без штрафа» раз в месяц. ([The Guardian][6])
* **Достижения/XP** за вехи, streak‑серии, «закрытие всех колец недели». 

---

## 8) Техническая реализация (коротко)

### 8.1. Хранилище

* `goals` / `milestones` / `progress_events` / `progress_snapshots` (агрегаты по дням).
* Идентичные ключи‑связки с Tasks/Habits/Finance (по ID и тегам).

### 8.2. Пайплайн

1. **Ingestion**: слушаем события из модулей.
2. **Compute**: пересчёт снапшота цели.
3. **Insights hook**: формируем инсайт/рекомендацию. 
4. **UI update**: Goals/Widgets/Finance.

### 8.3. Псевдокод расчета

```ts
function updateGoalProgress(goalId, event) {
  const g = getGoal(goalId), hist = getEvents(goalId, window=30d);
  const current = computeCurrent(g, hist);                   // по типу цели
  const percent = clamp((current - g.baseline)/(g.target-g.baseline), 0, 1);
  const paceActual = computePace(hist, g.cadence);           // /нед или /мес
  const paceReq = computeRequired(g, current, now, g.deadline);
  const eta = estimateETA(current, paceActual, g.target);
  const confidence = 1 - coeffOfVariation(paceActual.lastN);
  const onTrack = paceActual >= 0.9 * paceReq;
  saveSnapshot({goalId, date: now, current, percent, onTrack, eta, paceActual, paceReq, confidence});
}
```

### 8.4. API события

```http
POST /events
{
  "type": "finance_tx|task_completed|habit_marked|focus_session|manual_update",
  "goalId": "...", "payload": { ... }
}
```

---

## 9) Проверка краевых случаев

* **Изменение дедлайна/таргета** — сохраняем «историю параметров», показываем «до/после», не обнуляем прогресс.
* **Мультивалюта** — используем текущие/ручные курсы из Finance; фиксируем курс на момент вклада. 
* **Дубликаты транзакций/событий** — дедуп по (sourceId,timestamp,amount). 
* **Streak‑перегибы** — ограничиваем пуш‑частоту, есть «тихий режим», grace‑дни. ([The Guardian][6])

---

## 10) Что уже есть у вас и как мы «садимся» на это

* **PLANNER/Goals** — карточки с прогрессом, вехи, AI‑советы → добавляем расчетные поля `pace/ETA/confidence` и источники событий. 
* **Habits/Focus** — даем «кольца недели» и streak‑логику на цели‑нормативы. 
* **FINANCE** — цели‑накопления как «копилки», мультивалюта, бюджеты/аналитика/долги. 
* **INSIGHTS** — PDI и отчёты: добавляем раздел «Прогресс целей» + прогноз достижений/рекомендации. 
* **HOME/Widgets** — «GOALS» + «Focus/Tasks/Budget» индикаторы; единые кольца/бары. 
* **MORE/Gamification** — XP/уровни/ачивки триггерим от событий прогресса/закрытия вех/серий. 

---

## 11) Мини‑MVP по шагам (без дат, последовательность)

1. **Модель и хранилище UPE**: таблицы, миграции, снапшоты.
2. **Финцели**: связка с транзакциями Finance, курсы, вклад с карточки цели. 
3. **Нормативные цели**: недельные кольца + streak/grace.
4. **Вехи + Tasks**: чек‑лист цели с авто‑закрытием. 
5. **Insights**: ETA/On‑Track/инсайты в отчеты/PDI. 
6. **Home виджеты**: мини‑индикаторы и CTA. 
7. **Gamification**: XP за этапы/серии. 

---

## 12) Короткие ответы на «почему так» (с опорой на рынок)

* **Кольца и недельные нормы** — лучшее для ежедневной/недельной инерции (Apple, Todoist). ([Apple][1])
* **XP + вехи для навыков** — даёт микро‑мотивацию + видимый «этапный» прогресс (Duolingo). ([Duolingo Blog][2])
* **Пейс/ETA для денег и км** — снижает тревожность, даёт «сколько нужно вкладывать/бегать» (YNAB/Strava). ([support.ynab.com][5])
* **Grace‑дни для streak** — сохраняет здоровье и не ломает привычку из‑за одного дня. ([The Guardian][6])

---

Если нужно — могу сразу подготовить JSON‑контракты/SQL‑схему и макет состояний карточек («on‑track / at‑risk / catch‑up»), а также пресеты для 5–7 популярных целей (авто, отпуск, язык, книги, спорт, сертификация, погашение долга).

[1]: https://www.apple.com/watch/close-your-rings/?utm_source=chatgpt.com "Apple Watch - Close Your Rings"
[2]: https://blog.duolingo.com/how-duolingo-streak-builds-habit/?utm_source=chatgpt.com "The habit-building research behind your Duolingo streak"
[3]: https://www.todoist.com/karma?utm_source=chatgpt.com "Karma, a powerful way to track productivity"
[4]: https://support.strava.com/hc/en-us/articles/6822535085709-Goals-on-the-Strava-App?utm_source=chatgpt.com "Goals on the Strava App"
[5]: https://support.ynab.com/en_us/how-to-use-targets-rk5kkI9ks?utm_source=chatgpt.com "How to Use Targets in YNAB"
[6]: https://www.theguardian.com/lifeandstyle/article/2024/sep/08/streak-daily-ritual-can-enrich-your-life-or-become-unhealthy-obsession?utm_source=chatgpt.com "Don't break the streak! How a daily ritual can enrich your life - or become an unhealthy obsession"
[7]: https://developer.apple.com/design/human-interface-guidelines/activity-rings?utm_source=chatgpt.com "Activity rings | Apple Developer Documentation"
[8]: https://www.theverge.com/news/665315/duolingo-hearts-energy-system?utm_source=chatgpt.com "Duolingo is replacing hearts with energy"
